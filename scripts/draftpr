#!/usr/bin/env bash
# /qompassai/git/scripts/draftpr
# Qompass AI Github DraftPR Gen Script
# Copyright (C) 2026 Qompass AI, All rights reserved
####################################################
set -euo pipefail
ISSUE_NUMBER="3930"
BRANCH_SLUG="glitch-first-frame"
BASE_BRANCH_OVERRIDE=""
PR_TITLE="WIP: Fix glitching first frame on captured videos (#${ISSUE_NUMBER})"
PR_BODY=$'Status: Draft (planning and initial work)\n\n'"\
Related issue: basecamp/omarchy#${ISSUE_NUMBER}\n\n\
Design + experiments tracked in:\n\
- https://github.com/qompassai/arch/omarchy/blob/main/tracker.md#media\n\
- https://github.com/qompassai/arch/omarchy/tree/main/install/first-run\n"
CREATE_BRANCH_IF_MISSING=true
TARGET_REPO="basecamp/omarchy"
info()
{
  printf '==> %s\n' "$*"
}
warn()
{
  printf '!!  %s\n' "$*" >&2
}
error()
{
  printf 'ERROR: %s\n' "$*" >&2
  exit 1
}
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
  error "Not inside a git repository."
fi
info "Verifying remotes"
ORIGIN_URL=$(git remote get-url origin 2> /dev/null || echo "")
UPSTREAM_URL=$(git remote get-url upstream 2> /dev/null || echo "")
[[ -z $ORIGIN_URL ]] && error "'origin' remote is not configured."
[[ -z $UPSTREAM_URL ]] && error "'upstream' remote is not configured."
printf '  origin   = %s\n' "$ORIGIN_URL"
printf '  upstream = %s\n' "$UPSTREAM_URL"
if [[ $UPSTREAM_URL != *"${TARGET_REPO#*/}"* ]]; then
  warn "upstream does not look like ${TARGET_REPO}."
  printf '     Detected upstream URL: %s\n' "$UPSTREAM_URL"
  printf '     Expected to contain:   %s\n' "${TARGET_REPO#*/}"
  printf 'Continue anyway? [y/N] '
  read -r ans
  if [[ $ans != "y" && $ans != "Y" ]]; then
    error "Aborting by user choice."
  fi
fi
if ! git diff --quiet || ! git diff --cached --quiet; then
  error "Working tree has uncommitted changes. Commit or stash first."
fi
info "Fetching upstream"
git fetch upstream --prune
if [[ -n $BASE_BRANCH_OVERRIDE ]]; then
  BASE_BRANCH="$BASE_BRANCH_OVERRIDE"
else
  upstream_head_ref=$(git symbolic-ref --quiet --short "refs/remotes/upstream/HEAD" 2> /dev/null || true)
  if [[ -z $upstream_head_ref ]]; then
    warn "Could not resolve upstream/HEAD; falling back to 'master'."
    BASE_BRANCH="master"
  else
    BASE_BRANCH="${upstream_head_ref#upstream/}"
  fi
fi
info "Using upstream base branch: ${BASE_BRANCH}"
if ! git show-ref --verify --quiet "refs/remotes/upstream/${BASE_BRANCH}"; then
  error "upstream/${BASE_BRANCH} does not exist."
fi
PR_BRANCH="wip-${ISSUE_NUMBER}-${BRANCH_SLUG}"
info "Ensuring local branch '${PR_BRANCH}' exists and is based on upstream/${BASE_BRANCH}"
if git show-ref --verify --quiet "refs/heads/${PR_BRANCH}"; then
  info "Branch ${PR_BRANCH} already exists locally. Checking it out."
  git checkout "${PR_BRANCH}"
else
  if [[ $CREATE_BRANCH_IF_MISSING == true ]]; then
    info "Creating branch ${PR_BRANCH} from upstream/${BASE_BRANCH}"
    git checkout -b "${PR_BRANCH}" "upstream/${BASE_BRANCH}"
  else
    error "Branch ${PR_BRANCH} does not exist and CREATE_BRANCH_IF_MISSING=false."
  fi
fi
if ! git diff --quiet || ! git diff --cached --quiet; then
  error "Branch ${PR_BRANCH} has uncommitted changes. Commit or stash first."
fi
info "Pushing branch to origin (if needed)"
git push -u origin "${PR_BRANCH}"
if ! command -v gh > /dev/null 2>&1; then
  error "'gh' (GitHub CLI) is not installed."
fi
if ! gh auth status > /dev/null 2>&1; then
  error "'gh' is not authenticated. Run 'gh auth login' first."
fi
info "Checking for existing PR for this branch"
EXISTING_PR=$(gh pr list \
  --repo "${TARGET_REPO}" \
  --head "qompassai:${PR_BRANCH}" \
  --state all \
  --json number \
  --jq '.[0].number' 2> /dev/null || echo "")
if [[ -n ${EXISTING_PR} && ${EXISTING_PR} != "null" ]]; then
  info "A PR already exists for branch ${PR_BRANCH}: #${EXISTING_PR}"
  info "Opening in browser..."
  gh pr view "${EXISTING_PR}" --repo "${TARGET_REPO}" --web
  exit 0
fi
info "Creating draft PR via GitHub CLI"
gh pr create \
  --repo "${TARGET_REPO}" \
  --base "${BASE_BRANCH}" \
  --head "qompassai:${PR_BRANCH}" \
  --title "${PR_TITLE}" \
  --body "${PR_BODY}" \
  --draft
info "Draft PR created successfully."
